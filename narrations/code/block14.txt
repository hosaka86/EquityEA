Now the CloseAllPositions function, (break) which implements robust position closing logic. (long-break) We count how many positions exist, (break) and iterate backwards to avoid index shifting issues. (break) For each position, (break) we must select it by ticket to ensure our data is current. (long-break) We check if trading is allowed on the symbol. (break) Then we prepare a trade request structure, (break) setting the action to deal, (break) specifying the position ticket, volume, and symbol. (break) We use the symbol's correct filling mode. (long-break) For buy positions, (break) we close with a sell order at the bid price. (break) For sell positions, (break) we close with a buy order at the ask price. (break) We implement retry logic with up to three attempts. (long-break) If the price becomes invalid, (break) we refresh it and retry. (break) If the market is closed, (break) we stop trying. (break) We only log errors after all retry attempts have failed, (break) keeping the terminal output clean. (break) At the end, (break) we print a summary of how many positions were closed or failed. (long-break)